# Codebase Review & Refactoring Notes (`src/` Directory)

This document contains a comprehensive review of the `src/` directory, conducted from the perspectives of Architecture, Security, QA, and Development.

## 1. Architect's Review

**Focus:** SOLID principles, Dependency Injection, and Event-Driven Architecture.

*   **Violation of Dependency Inversion (Tight Coupling):**
    *   *Location:* `src/Features/MarkdownRenderer/Feature.php` (and likely other features).
    *   *Issue:* Dependencies like `MarkdownProcessor`, `ContentExtractor`, and `TemplateRenderer` are instantiated directly using the `new` keyword inside the `register()` method.
    *   *Recommendation:* Features should not instantiate their own complex dependencies. These services should be registered in the `EICC\Utils\Container` during bootstrap and injected into the Feature, or retrieved from the container. This makes the system more modular and testable.
*   **Application Bootstrap Coupling:**
    *   *Location:* `src/Core/Application.php`
    *   *Issue:* The constructor pulls dependencies directly from the container (`$this->eventManager = $container->get(...)`) rather than using constructor injection. While acceptable in a framework kernel, moving towards full constructor injection for core components improves clarity.
*   **Custom Event Documentation:**
    *   *Location:* `src/Features/MarkdownRenderer/Services/MarkdownRendererService.php`
    *   *Issue:* The service fires a custom `MARKDOWN_CONVERTED` event. This is excellent for extensibility (e.g., allowing the Table of Contents feature to hook in), but this event is not documented in the core lifecycle in `AGENT.md`.
    *   *Recommendation:* Document all custom events that features are expected to interact with.

## 2. Security Expert's Review

**Focus:** Input sanitization, file handling, and secure defaults.

*   **Directory Traversal Risks:**
    *   *Location:* `src/Features/MarkdownRenderer/Services/MarkdownRendererService.php`
    *   *Issue:* The service reads files using `file_get_contents($filePath)`. While `$filePath` is presumably generated by `FileDiscovery`, there should be a strict validation step ensuring that `$filePath` absolutely resolves to a path within the `content/` directory before reading it.
*   **XSS in Template Rendering:**
    *   *Location:* `src/Services/TemplateRenderer.php`
    *   *Issue:* The renderer passes parsed HTML to Twig. If the Twig templates use the `|raw` filter to render the markdown content (which is standard for SSGs), any raw HTML embedded in the original Markdown files will be executed.
    *   *Recommendation:* Implement an HTML purifier or sanitization step *after* Markdown conversion but *before* Twig rendering, unless the system explicitly trusts all Markdown authors.

## 3. QA Engineer's Review

**Focus:** Testability, edge cases, and error handling.

*   **Untestable Feature Classes:**
    *   *Location:* `src/Features/*/Feature.php`
    *   *Issue:* Because dependencies are hardcoded with `new` inside the `register` methods, it is impossible to mock the `TemplateRenderer` or `MarkdownProcessor` when writing unit tests for the Feature classes.
    *   *Recommendation:* Refactor to use the Container for dependency resolution.
*   **Error Suppression Operator (`@`):**
    *   *Location:* `src/Features/MarkdownRenderer/Services/MarkdownRendererService.php` (Line 62)
    *   *Issue:* The code uses `@file_get_contents($filePath)`. The `@` operator suppresses PHP warnings, making debugging difficult if a file is unreadable due to permissions.
    *   *Recommendation:* Remove the `@` operator. Use `is_readable($filePath)` before attempting to read, and throw a descriptive `RuntimeException` if it fails.
*   **Template Fallback Logging:**
    *   *Location:* `src/Services/TemplateRenderer.php`
    *   *Issue:* When template rendering fails, it catches the exception and falls back to `applyBasicTemplate`.
    *   *Recommendation:* Ensure the logged error explicitly states *which* template file failed to render and *why*, to aid template developers in debugging syntax errors.

## 4. Senior Developer's Review

**Focus:** DRY violations, modern PHP practices, and code smells.

*   **Outdated Constructor Boilerplate:**
    *   *Location:* `src/Features/MarkdownRenderer/Services/MarkdownRendererService.php` (and others).
    *   *Issue:* The project uses PHP 8.4, but classes are still using PHP 7-style constructor assignments.
    *   *Recommendation:* Utilize **Constructor Property Promotion** to reduce boilerplate.
    *   *Example:*
        ```php
        // Instead of:
        private Log $logger;
        public function __construct(Log $logger) { $this->logger = $logger; }

        // Use:
        public function __construct(private Log $logger) {}
        ```
*   **Single Responsibility Principle (SRP) in TemplateRenderer:**
    *   *Location:* `src/Services/TemplateRenderer.php`
    *   *Issue:* The `render()` method contains complex logic for determining which template to use (checking frontmatter, then category, then fallback).
    *   *Recommendation:* Extract this logic into a dedicated `TemplateResolverService`. `TemplateRenderer` should only be responsible for taking a template path and variables, and returning HTML.
*   **Code Style Violations:**
    *   *Issue:* Running `lando phpcs src/` reveals several minor PSR-12 violations (line lengths exceeding 120 characters, multi-line control structure formatting).
    *   *Recommendation:* Run `lando phpcbf` to automatically fix the formatting issues, and adjust line lengths in `AlertShortcode.php`, `BaseRendererService.php`, and `SftpClient.php`.